import re
import sys
from pathlib import Path
from datetime import datetime

from docx import Document


# -------------------------
# è‡ªå‹•å˜—è©¦ç·¨ç¢¼è®€å–
# -------------------------
def read_text_auto(path: Path) -> str:
    for enc in ("utf-8-sig", "utf-8", "cp950", "big5", "utf-16"):
        try:
            return path.read_text(encoding=enc)
        except UnicodeDecodeError:
            continue
    return path.read_text(encoding="utf-8", errors="ignore")


# -------------------------
# å»æ‰ SRT çš„åºè™Ÿ/æ™‚é–“è»¸ï¼Œåªç•™å­—å¹•
# -------------------------
TIME_RE = re.compile(r"^\d{2}:\d{2}:\d{2}[,\.]\d{3}\s*-->\s*\d{2}:\d{2}:\d{2}[,\.]\d{3}")

def extract_subtitle_lines_from_srt(srt_path: Path) -> list[str]:
    text = read_text_auto(srt_path)
    lines = text.splitlines()

    out_lines: list[str] = []
    for line in lines:
        line = line.strip()
        if not line:
            continue
        if line.isdigit():
            continue
        if TIME_RE.match(line):
            continue
        out_lines.append(line)
    return out_lines


# -------------------------
# SRT -> TXTï¼ˆåŒå TXT å­˜åœ¨å¯è·³éï¼‰
# -------------------------
def write_txt_if_needed(srt_path: Path, lines: list[str], *, skip_if_exists: bool = True) -> str:
    txt_path = srt_path.with_suffix(".txt")
    if skip_if_exists and txt_path.exists():
        return "skipped"
    txt_path.write_text("\n".join(lines), encoding="utf-8")
    return "converted"


# -------------------------
# æ‰¾åˆ°ã€Œæœ€å¯èƒ½ã€çš„åŒå DOCX
# - å…ˆç²¾æº–æ‰¾ï¼šåŒ stem çš„ .docx
# - æ‰¾ä¸åˆ°å†æ‰¾ï¼šstem*.docxï¼ˆæª”åå¯èƒ½å¤šäº†å¾Œç¶´ï¼‰
# - å¤šå€‹å€™é¸ï¼šæŒ‘æœ€æ–°ä¿®æ”¹æ™‚é–“
# -------------------------
def find_matching_docx(srt_path: Path) -> Path | None:
    exact = srt_path.with_suffix(".docx")
    if exact.exists():
        return exact

    # å…è¨±åŒç›®éŒ„ä¸‹æœ‰å¾Œç¶´ç‰ˆæœ¬ï¼šxxx*.docx
    candidates = list(srt_path.parent.glob(srt_path.stem + "*.docx"))
    if not candidates:
        return None

    # å–æœ€æ–°ä¿®æ”¹çš„é‚£ä»½
    candidates.sort(key=lambda p: p.stat().st_mtime, reverse=True)
    return candidates[0]


# -------------------------
# è¿½åŠ å¯«å…¥ DOCXï¼ˆè‹¥å­˜åœ¨ï¼‰
# - è‹¥å­˜æª”è¢«é–ä½ï¼Œæœƒæ”¹å­˜æˆ *_APPENDED_yyyymmdd_hhmmss.docx
# -------------------------
def append_to_docx_if_exists(srt_path: Path, lines: list[str]) -> tuple[str, str]:
    docx_path = find_matching_docx(srt_path)
    if not docx_path:
        return "no_docx", ""

    try:
        doc = Document(str(docx_path))
        ts = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        doc.add_paragraph("")  # ç©ºä¸€è¡Œ
        doc.add_paragraph(f"ã€SRTè½‰å…¥ã€‘{srt_path.name}  ({ts})")

        for t in lines:
            doc.add_paragraph(t)

        try:
            doc.save(str(docx_path))
            return "appended", str(docx_path)
        except PermissionError:
            # Word é–‹è‘—å¸¸è¦‹ï¼šå¦å­˜æ–°æª”é¿å…ä½ ä»¥ç‚ºæ²’æˆåŠŸ
            ts2 = datetime.now().strftime("%Y%m%d_%H%M%S")
            alt = docx_path.with_name(docx_path.stem + f"_APPENDED_{ts2}" + docx_path.suffix)
            doc.save(str(alt))
            return "saved_as_copy", str(alt)

    except Exception as e:
        return f"failed: {e}", str(docx_path)


# -------------------------
# å–å¾—ä½¿ç”¨è€…è¼¸å…¥ï¼ˆæ”¯æ´åƒæ•¸ or äº’å‹•ï¼‰
# -------------------------
def get_input_path() -> str:
    if len(sys.argv) >= 2:
        return " ".join(sys.argv[1:]).strip()
    print("è«‹è¼¸å…¥ SRT æª”æ¡ˆæˆ–è³‡æ–™å¤¾è·¯å¾‘ï¼ˆå¯ç›´æ¥æ‹–æ›³é€²ä¾†ï¼‰ï¼š")
    return input(">> ").strip()

def clean_path(p: str) -> str:
    p = (p or "").strip()
    if (p.startswith('"') and p.endswith('"')) or (p.startswith("'") and p.endswith("'")):
        p = p[1:-1].strip()
    return p


# -------------------------
# å–®æª”è™•ç†
# -------------------------
def process_one_srt(srt: Path) -> tuple[bool, str, str, str, int]:
    """
    å›å‚³: (ok, txt_status, docx_status, docx_written_path, line_count)
    """
    try:
        lines = extract_subtitle_lines_from_srt(srt)
        txt_status = write_txt_if_needed(srt, lines, skip_if_exists=True)
        docx_status, docx_written_path = append_to_docx_if_exists(srt, lines)
        return True, txt_status, docx_status, docx_written_path, len(lines)
    except Exception as e:
        return False, "failed", f"failed: {e}", "", 0


# -------------------------
# main
# -------------------------
def main():
    raw = clean_path(get_input_path())

    print("--------------------------------------------------")
    print("æ”¶åˆ°çš„è·¯å¾‘ï¼š", raw)
    print("--------------------------------------------------")

    if not raw:
        print("âŒ æœªè¼¸å…¥ä»»ä½•è·¯å¾‘")
        return

    path = Path(raw)
    if not path.exists():
        print("âŒ è·¯å¾‘ä¸å­˜åœ¨ï¼š", path)
        return

    # å–®æª”
    if path.is_file():
        if path.suffix.lower() != ".srt":
            print("âŒ é€™ä¸æ˜¯ .srt æª”ï¼š", path)
            return

        ok, txt_status, docx_status, docx_written, n = process_one_srt(path)
        if not ok:
            print("âŒ è½‰æ›å¤±æ•—ï¼š", path)
            print("TXT:", txt_status, "| DOCX:", docx_status)
            return

        # TXT ç‹€æ…‹
        if txt_status == "skipped":
            print(f"â­ï¸  TXTè·³éï¼ˆå·²å­˜åœ¨ï¼‰ï¼š{path.with_suffix('.txt')}")
        else:
            print(f"âœ… TXTå®Œæˆï¼š{path.with_suffix('.txt')}ï¼ˆè¡Œæ•¸ {n}ï¼‰")

        # DOCX ç‹€æ…‹
        if docx_status == "no_docx":
            print("â„¹ï¸ åŒç›®éŒ„æ‰¾ä¸åˆ°å¯å¯«å…¥çš„ DOCXï¼ˆéœ€åŒåæˆ–åŒåé–‹é ­ *.docxï¼‰ã€‚")
        elif docx_status == "appended":
            print(f"âœ… DOCXå·²è¿½åŠ ï¼š{docx_written}")
        elif docx_status == "saved_as_copy":
            print("âš ï¸ DOCX åŸæª”å¯èƒ½è¢« Word é–‹è‘—é–ä½ï¼Œå·²æ”¹å­˜æˆæ–°æª”ï¼š")
            print(f"âœ… DOCXå·²è¿½åŠ (å¦å­˜)ï¼š{docx_written}")
        else:
            print(f"âŒ DOCXè¿½åŠ å¤±æ•—ï¼š{docx_status}")
            if docx_written:
                print("   ç›®æ¨™DOCXï¼š", docx_written)

        return

    # è³‡æ–™å¤¾ï¼ˆå«å­ç›®éŒ„ï¼‰
    if path.is_dir():
        srt_files = list(path.rglob("*.srt"))
        if not srt_files:
            print("âš ï¸ è³‡æ–™å¤¾å…§ï¼ˆå«å­ç›®éŒ„ï¼‰æ‰¾ä¸åˆ°ä»»ä½• .srt")
            return

        converted = 0
        skipped = 0
        failed = 0
        docx_appended = 0
        docx_saved_copy = 0
        docx_missing = 0
        docx_failed = 0

        print(f"ğŸ” æ‰¾åˆ° {len(srt_files)} å€‹ SRTï¼ˆTXT åŒåå­˜åœ¨æœƒè·³éï¼›DOCX åŒå/åŒåé–‹é ­å­˜åœ¨æœƒè¿½åŠ ï¼‰")
        print("é–‹å§‹è™•ç†...")

        for srt in srt_files:
            ok, txt_status, docx_status, docx_written, _ = process_one_srt(srt)

            if not ok:
                failed += 1
                print("âŒ [å¤±æ•—]", srt)
                continue

            if txt_status == "skipped":
                skipped += 1
                print("â­ï¸  [TXTè·³é]", srt)
            else:
                converted += 1
                print("âœ… [TXTå®Œæˆ]", srt)

            if docx_status == "appended":
                docx_appended += 1
                print("   â†³ âœ… [DOCXè¿½åŠ ]", docx_written)
            elif docx_status == "saved_as_copy":
                docx_saved_copy += 1
                print("   â†³ âš ï¸ [DOCXè¢«é– å¦å­˜è¿½åŠ ]", docx_written)
            elif docx_status == "no_docx":
                docx_missing += 1
            else:
                docx_failed += 1
                print("   â†³ âŒ [DOCXå¤±æ•—]", docx_status, "|", docx_written or "")

        print("--------------------------------------------------")
        print(f"ğŸ‰ TXTï¼šæˆåŠŸ {converted} / è·³é {skipped} / å¤±æ•— {failed} / ç¸½æ•¸ {len(srt_files)}")
        print(f"ğŸ“„ DOCXï¼šç›´æ¥è¿½åŠ  {docx_appended} / è¢«é–å¦å­˜ {docx_saved_copy} / ç„¡DOCX {docx_missing} / å¤±æ•— {docx_failed}")
        return

    print("âŒ ä¸æ”¯æ´çš„è·¯å¾‘å‹æ…‹ï¼š", path)


if __name__ == "__main__":
    main()
    input("\næŒ‰ Enter çµæŸ...")
